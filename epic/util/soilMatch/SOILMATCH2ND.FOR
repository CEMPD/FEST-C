C     PROGRAM SET UP FOR SECOND LEVEL MATCH HUC8 BY CROP GROUPS

C     THIS PROGRAM LINKS A SOIL TO A CROP BY 12 KM GRID 
C     USING DOMINANT HUC8 SOILS BY CROP BUT ALLOWING SOIL MATCHES
C     BY CROP TYPES VERSUS CROP SPECIFIC
C     VARIABLES TO SELECT SOIL FILE
C     SOILNAME = SOILS 5 SOIL SERIES NAME
C     SOILNAMEM = SOILS 5 SOIL SERIES NAME
C     OF A MATCHED NRI/HUC/CROP SOIL WITH A BAUMER SOIL FILE 
C
C     MUSYB = THE SOIL MAPPING UNIT SYMBOL THAT MAY BE SOIL SURVEY SPECIFIC
C     MUSYBM = THE SOIL MAPPING UNIT SYMBOL THAT MAY BE SOIL SURVEY SPECIFIC
C     OF A MATCHED NRI/HUC/CROP SOIL WITH A BAUMER SOIL FILE 
C
C     TEXTURE = THE SOIL TEXTURE UP TO 6 CHARACTERS
C     TEXTUREM = THE SOIL TEXTURE UP TO 6 CHARACTERS
C     OF A MATCHED NRI/HUC/CROP SOIL WITH A BAUMER SOIL FILE 
C
C     SOIL5 = THE 6 CHARACTER ALPHA NUMERIC SOILS 5 CODE FROM THE BAUMER FILE LIST
C     SOIL5M = THE 6 CHARACTER ALPHA NUMERIC SOILS 5 CODE FROM THE BAUMER FILE LIST
C     OF A MATCHED NRI/HUC/CROP SOIL WITH A BAUMER SOIL FILE
C
C     STEXT = THE BAUMER SOIL FILE EXTENSION CODE
C     STEXTM = THE BAUMER SOIL FILE EXTENSION CODE OF A MATCHED NRI/HUC/CROP SOIL 
C     WITH A BAUMER SOIL FILE 
C
C     HYDRO = THE SOIL HYDROLOGIC GROUP CODE
C     HYDROM = THE SOIL HYDROLOGIC GROUP CODE
C     OF A MATCHED NRI/HUC/CROP SOIL WITH A BAUMER SOIL FILE 
C     KR = ARRAY OF FILE NUMBER READ
C     KW = ARRAY OF FILE NUMBERS WRITTEN
C     FIPS = THE 5-DIGIT COUNTY CODE USED BY THE CENSUS WHERE THE FIRST 2-DIGITS 
C     ARE THE STATE NUMERIC CODE AND THE NEXT 3-DIGITS ARE THE COUNTY NUMERIS CODE
C
C     FIPSM = THE 5-DIGIT COUNTY CODE USED BY THE CENSUS WHERE THE FIRST 2-DIGITS 
C     ARE THE STATE NUMERIC CODE AND THE NEXT 3-DIGITS ARE THE COUNTY NUMERIC CODE 
C     OF A MATCHED NRI/HUC/CROP SOIL WITH A BAUMER SOIL FILE 
C
C     CLT = DEGREES PER RADIAN

	CHARACTER*29 SOILNAME,SOILNAMEM 
	CHARACTER*6 MUSYB,TEXTURE,SOIL5,SOIL5M,MUSYBM,TEXTUREM
	CHARACTER*7 STEXT,STEXTM
	CHARACTER*3 HYDRO,HYDROM
      DIMENSION KR(2),KW(2)
	INTEGER FIPS,FIPSM
      DATA CLT/57.296/,SOIL5M/'      '/,STEXTM/'       '/
      DATA KR/41,42/,KW/51,52/

C     PROGRAMING TO IDENTIFY SOIL5 FROM NRI DATA
C     ASOILN = SOILS 5 CODE NAME IN NRI FILE
C     SOILV = SOILS 5 CODE NAME IN BAUMER FILE LIST
C     TITLE = TITLE LINE IN FILES THAT IS READ BUT NOT USED BY THE PROGRAM
C     NRINAME = SOILS 5 NAME IN NRI FILE
C     BELD4NAME = BELD4 CROP NAME
C     BELD4CODE = 2-DIGIT CROP CODE (22 TO 59)
C     BELDCROSS = ARRAY WITH NRI CROSS REFERENCE TO NRI CROP CODES
C     HUCINDEXS = ARRAY TO STORE HUC8 CODE BY HUC FILE SEQUENCE NUMBER AS READ
C     ALONGS = ARRAY TO STORE HUC8 LONGITUDE BY HUC FILE SEQUENCE NUMBER AS READ
C     ALATS = ARRAY TO STORE HUC8 LATITUDE BY HUC FILE SEQUENCE NUMBER AS READ
C     ELEVS = ARRAY TO STORE HUC8 ELEVATION BY HUC FILE SEQUENCE NUMBER AS READ
C     SLOPES = ARRAY TO STORE HUC8 SLOPE BY HUC FILE SEQUENCE NUMBER AS READ
C     ICODELUS = ARRAY TO STORE HUC8 MODIS_LU CODE BY HUC FILE SEQUENCE NUMBER AS READ
C     HUCINDEX = SEQUENCE NUMBER OF HUC SITES AS DATA IS READ

C       Added by UNC, dyang
C       Environment variables used by this management program
        CHARACTER*300  SCENDIR, COMMDIR, SHAREDIR, UTILDIR, CROPDIR, WORKDIR
        CHARACTER*30   CROPNAME
C       end add by UNC, dyang

	CHARACTER*6 ASOILN,SOILV,SOILVM
	CHARACTER*80 TITLE
      CHARACTER*30 NRINAME
	CHARACTER*20 BELD4NAME
	INTEGER BELD4CODE,BELDCROSS,HUCINDEXS,HUCINDEX,IGRID12KM
        REAL LSLOPEM, USLOPEM, LSLOPE, USLOPE

      DIMENSION IHUC8N(1),BELDCROSS(60),HUCINDEXS(2300),
     1ALONGS(2300),ALATS(2300),ELEVS(2300),SLOPES(2300),ICODELUS(2300)

C       Added by UNC, dyang
C       Environment variables used by this management program
       CALL GETENV( "SCEN_DIR", SCENDIR )
       CALL GETENV( "WORK_DIR", WORKDIR )
       CALL GETENV( "SHARE_DIR", SHAREDIR )
       CALL GETENV( "COMM_DIR", COMMDIR )
       CALL GETENV( "CROP_NAME", CROPNAME )
       CROPDIR = trim(SCENDIR)//'/'//trim(CROPNAME)
       UTILDIR = trim(COMMDIR)//'/util/soilMatch' 

C     FILE LISTING ALL BAUMER SOIL FILES FOR CULTIVATED OR MANAGED CROPLAND
	CALL OPENV(KR(1),'ALL-CULTIVATED10-12-09.LST', UTILDIR, 'R' )
C     OUTPUT FILE FROM DISTANCE CALCULATOR ROUTINE TO CHECK RESULTS
C 	OPEN(KW(1),FILE='DISTCALC.OUT', WORKDIR)
        CALL OPENV (KW(1),'DISTCALC.OUT', WORKDIR, '' )
C     BELD4 CODE LIST TO BE PROCESSED
C     ALL CROPS ALLHUC8S BY 12 KM GRID
C     OLD CODE
C	OPEN (21,FILE='ALLBELD4HUC8CROPS.prn')
C     OUTPUT FILE WITH DISTANCE FOR CLOSEST BAUMER FILE WITH SAME SOILS 5 CODE BY HUC8
C    FIRST LEVEL MATCH 
C	OPEN (21,FILE='CROP12KMLIST.DAT')
C     VALIDATE CROP BY GRID DATA
	CALL OPENV (22,'CROPS12KMTEST.DAT', CROPDIR, 'W' )
C	OPEN(KW(2),FILE='SOILSKM1.LOC')
C     FILE TO LIST 12KM/BELD4 CATEGORIES WHERE NO MATCH WAS FOUND
C      OPEN (29,FILE='NONRISOIL1ST.DAT')

C     SECOND LEVEL MATCH
	CALL OPENV (21,'NONRISOIL1ST.DAT', CROPDIR, 'R')
	CALL OPENV (KW(2),'SOILSKM2.LOC', CROPDIR, 'W')
	CALL OPENV (29,'NONRISOIL2ND.DAT', CROPDIR, 'W')


C     THIRD LEVEL MATCH
C	OPEN (21,FILE='NONRISOIL2ND.DAT')
C	OPEN(KW(2),FILE='SOILSKM3.LOC')
C	OPEN (29,FILE='NONRISOIL3RD.DAT')


C     FOURTH LEVEL MATCH
C	OPEN (21,FILE='NONRISOIL3RD.DAT')
C	OPEN(KW(2),FILE='SOILSKM4.LOC')
C	OPEN (29,FILE='NONRISOIL4TH.DAT')


C     FIFTH LEVEL MATCH
C	OPEN (21,FILE='NONRISOIL4TH.DAT')
C	OPEN(KW(2),FILE='SOILSKM5.LOC')
C	OPEN (29,FILE='NONRISOIL5TH.DAT')

C     SIXTH LEVEL MATCH
C	OPEN (21,FILE='NONRISOIL5TH.DAT')
C	OPEN(KW(2),FILE='SOILSKM6.LOC')
C	OPEN (29,FILE='NONRISOIL6TH.DAT')


C     NRI LIST OF SOILS 5 SOILS IN NUMERICAL ORDER BY HUC8, NRI CROP CODE AND NRI WEIGHTING
C     FACTOR FROM HEIGHTEST TO LOWEST WITHIN HUC 8 AND CROP SEQUENCE
	CALL OPENV (25,'NRI-ALL-HUC8S-ALLCROPS.prn', UTILDIR, 'R')
C     OUTPUT TO VALIDATE INPUT ABOVE WAS READ CORRECTLY
	CALL OPENV (26,'validate.DAT', CROPDIR, 'R')
C     OUTPUT TO VALIDATE INPUT BELOW WAS READ CORRECTLY
	CALL OPENV (27,'NRI-crop-codes-BELD4-codes.TST', CROPDIR, 'W')
C     FILE WITH NRI AND BELD4 CROP CROSS REFERENCE INFORMATION 
C     INCLUDING CROP NUMBERS ASSIGNED FOR BELD4 CROPS NOT IN NRI LIST 
	CALL OPENV (28,'NRI-crop-codes-BELD4-codes.prn',  UTILDIR, 'R')
C     FILE LISTING SOILS TO BE LINKED TO HUC8 BELD4 CROP EPIC FILES
	CALL OPENV (30,'HUC8NRICROPSOIL.DAT',  WORKDIR, 'W')
C     DATA OUTPUT FILE USED TO DEBUG PROGRAM
	CALL OPENV (31,'TEST.DAT', CROPDIR, 'W')
C     HUC8 SITE DATA FILE
	CALL OPENV (32,'HUC8_SITE_INFO-2REV.PRN', UTILDIR, 'R')
C     HUC8 SITE DATA VERFICATION FILE
	CALL OPENV (33,'HUC8_SITE_INFO-2REV.TST', CROPDIR, 'W')
C     HUC8 SITE LATITUDE AND LONGITUDE USED IN DISTANCE CALCULATION
        CALL OPENV (34,'HUCSITELATLONG.DAT', WORKDIR, 'W')
C     READ HUC8 SITE DATA
      HUCINDEX=0
	READ(32,443) TITLE
   22 HUCINDEX=HUCINDEX + 1
      READ(32,201,END=997) IHUC8S,ALOG,ALAT,ELEV,SLOPE,ICODELU
      HUCINDEXS(HUCINDEX)=IHUC8S
	ALONGS(HUCINDEX)=ALOG*(-1)
	ALATS(HUCINDEX)=ALAT
	ELEVS(HUCINDEX)=ELEV
	SLOPES(HUCINDEX)=SLOPE
      ICODELUS(HUCINDEX)=ICODELU
C      WRITE(33,202)HUCINDEXS(HUCINDEX),ALONGS(HUCINDEX),
C     1ALATS(HUCINDEX),ELEVS(HUCINDEX),SLOPES(HUCINDEX),
C     2ICODELUS(HUCINDEX),HUCINDEX
  201 FORMAT(3X,I8,10X,F9.4,9X,F9.4,F10.0,10X,F8.4,6X,2I8)
  202 FORMAT(1X,I8,2F10.4,F10.0,F10.4,2I8)
	GO TO 22
  997 CONTINUE
C     NRI-BELD4 CROSS-REFERENCE
  992	READ(28,443)TITLE
C	WRITE(27,443)TITLE
      
   12 READ(28,441,END=991) NRICODE,NRINAME,BELD4NAME,BELD4CODE,NRIBELD4
      BELDCROSS(BELD4CODE)=NRIBELD4
      WRITE(27,442) NRICODE,NRINAME,BELD4NAME,BELD4CODE,NRIBELD4,
     1BELDCROSS(BELD4CODE)
	GO TO 12
  441 FORMAT(5X,I3,A30,18X,A20,I5,3X,I5)
  442 FORMAT(5X,I3,A30,18X,A20,I5,3X,2I5)

  991 CONTINUE
C     FIRST LEVEL MATCH
C   15 READ(21,440,END=999) IGRID12KM,ICRPBELD,IHUC8
C  440 FORMAT(2X,I6,I6,38X,I10)
C 7440 FORMAT(2X,2I6,I10)
C      WRITE(22,7440) IGRID12KM,ICRPBELD,IHUC8

C     SECOND THROUGH SIXTH LEVELS
   15 READ(21,440,END=999) IHUC8,ICRPBELD,INRICRP,IGRID12KM
  440 FORMAT(2I8,17X,I4,10X,I10)

 7440 FORMAT(2X,4I10)
      WRITE(22,7440) IHUC8,ICRPBELD,INRICRP,IGRID12KM

      READ(25,443)TITLE
C	WRITE(26,443)TITLE

    1	READ(25,444,END=998)IHUC,ICROPN,ASOILN,ACRE,ACREWT
C	WRITE(26,444)IHUC,ICROPN,ASOILN,ACRE,ACREWT
	ICROSS=BELDCROSS(ICRPBELD)
C	WRITE(31,420) IHUC8,ICRPBELD,IHUC,ICROPN,ICROSS
  420 FORMAT(1X,5I10)
      IHUC6=IHUC8/100
	IHUCNRI6=IHUC/100
	IHUC4=IHUC8/1000
	IHUCNRI4=IHUC/1000

C      THIRD AND FOURTH LEVELS
C     USE THE FOLLOWING STATEMENT AND COMMENT OUT "IF(IHUC8.EQ.IHUC) GO TO 2"
C     TO MATCH SOILS AT HUC6 LEVEL
C	IF(IHUC6.EQ.IHUCNRI6) GO TO 2
	IF(IHUC8.EQ.IHUC) GO TO 2

C     FIFTH AND SIXTH LEVEL
C     USE THE FOLLOWING STATEMENT AND COMMENT OUT "IF(IHUC8.EQ.IHUC) GO TO 2" AND
C     "IF(IHUC6.EQ.IHUCNRI6) GO TO 2" TO MATCH SOILS AT THE HUC4 LEVEL
C     TO MATCH SOILS AT HUC6 LEVEL
C	IF(IHUC4.EQ.IHUCNRI4) GO TO 2

	GO TO 1

C     FIRST AND FIFTH LEVEL MATCH
C USE FOLLOWING STATEMENT 2 FOR CROP MATCH
C    2	IF(ICROSS.EQ.ICROPN) GO TO 20


C     SECOND AND THIRD LEVEL MATCH
C     USE NEXT 5 STATEMENTS IF THE MATCH IS BY ROW, CLOSE GROWN, AND
C     HAY AND PASTUE CROP GROUPS ONLY AND COMMENT OUT OTHER STATEMENT 2
    2 IF(ICROSS<100.AND.ICROPN<100.AND.ICROPN>6) GO TO 20
      IF(ICROSS>100.AND.ICROSS<200.AND.ICROPN>100.AND.ICROPN<200) 
     1GO TO 20
	IF(ICROSS>200.AND.ICROSS<411.AND.ICROPN>200.AND.ICROPN<411)
	1GO TO 20

C     FOURTH AND SIXTH LEVEL
C     TO MATCH TO ANY CROP AT THE HUC6 FOURTH LEVEL OR HUC4 FIFTH LEVEL
C     USE THE FOLLOWING 3 LINES OF CODE
C    2 IF(ICROSS<200.AND.ICROPN<200.AND.ICROPN>6) GO TO 20
C	IF(ICROSS>200.AND.ICROSS<411.AND.ICROPN>200.AND.ICROPN<411)
C	1GO TO 20

      IF(ICROSS.EQ.501) GO TO 3
	GO TO 5
    3 IF(ICROPN>100.AND.ICROPN<200) GO TO 20
C    3 IF(ICROPN.GT.100) GO TO 4
C      GO TO 5
C    4 IF(ICROPN.LT.200) GO TO 20
      GO TO 5
    5 IF(ICROSS.EQ.500) GO TO 20 

	GO TO 1
   20 SOILV=ASOILN
      WRITE(30,446) IHUC8,ICRPBELD,ICROPN,SOILV,ACREWT
C     OTTO SOIL MATCH
C     IDENTIFY HUC8 SITE LAT AND LONG
      DO 25 I=1,2119
C	WRITE(31,450)IHUC8,ICROPN,ICRPBELD,SOILV,HUCINDEXS(I),
C     1ALONGS(I),ALATS(I),ELEVS(I),SLOPES(I),
C     2ICODELUS(I),I
  450 FORMAT(1X,3I10,2X,A6,1X,I8,2F10.4,F10.0,F10.4,2I8)
	IF(HUCINDEXS(I).EQ.IHUC8) GO TO 24
	GO TO 25
   24	SITELAT=ALATS(I)
      SITELONG=ALONGS(I)
	GO TO 26
   25 CONTINUE
   26 CONTINUE
      WRITE(34,203)IHUC8,SITELAT,SITELONG
  203 FORMAT(1X,I8,2F10.4)
C     THIS ROUTINE CALCULATES DISTANCE BETWEEN TWO POINTS ON THE EARTH
      XLT1=0.
	RLT1=0.
	XX=10.
	D1=0.
	D2=0.
      XLOX=SITELONG
	YLAT=SITELAT
	RYT1=YLAT/CLT
	RXG1=XLOX/CLT
	C1=COS(RYT1)
	S1=SIN(RYT1)
	D=1.E20
   16	READ(KR(1),100,END=99)LSTN,NOTTO,SOIL5,STEXT,SOILNAME,MUSYB,
     1TEXTURE,LSLOPE,USLOPE,HYDRO,FIPS,Y,X

C	WRITE(31,448) SOIL5,SOILV 
  448 FORMAT(1X,2(2X,A6))
	IF(SOIL5.EQ.SOILV) GO TO 17
	GO TO 16
   17 CONTINUE
	ISTATE=FIPS/1000
	LSTNSOIL= ISTATE*10000+LSTN
  100 FORMAT(3X,I6,1X,I5,A6,A7,2X,A29,A6,A6,1X,2F4.0,26X,A3,26X,I5,2X,
     12F10.3)
  101 FORMAT(3X,I6,1X,I5,A6,A7,2X,A29,A6,A6,1X,2F4.0,2X,A3,2X,I5,2X,
     22F10.3,2X,4I10,2X,A6,F10.0)

	X=ABS(X)
	RY=Y/CLT
	RX=X/CLT
	DX=3963.*1.609*ACOS(S1*SIN(RY)+C1*COS(RY)*COS(RX-RXG1))
	IF(DX>D)GO TO 16
	D=DX
	YLATM=YLAT
	XLOXM=XLOX
	NOTTOM=NOTTO
	SOIL5M=SOIL5
	STEXTM=STEXT
      
	LSTNSOILM=LSTNSOIL
	SOILNAMEM=SOILNAME
	MUSYBM=MUSYB
	TEXTUREM=TEXTURE
	LSLOPEM=LSLOPE
	USLOPEM=USLOPE
	HYDROM=HYDRO
	FIPSM=FIPS
	YM=Y
	XM=X
	ISTATEM=ISTATE
	IHUC8M=IHUC8
	ICROPNM=ICROPN
	ICRPBELDM=ICRPBELD
	SOILVM=SOILV

	DM=D 
	MATCH=1
	GO TO 16
      IF(MATCH.GT.0)WRITE(KW(1),101)LSTNSOIL,NOTTO,SOIL5,STEXT,
     1SOILNAME,MUSYB,TEXTURE,LSLOPE,USLOPE,HYDRO,FIPS,Y,X,ISTATE,
     2IHUC8,ICROPN,ICRPBELD,SOILV,ACREWT

   99 CONTINUE
C     OLD HUC8 MATCH LIST FOR SOIL
C      IF(MATCH.GT.0)WRITE(KW(2),439)IHUC8,ICRPBELD,

      IF(MATCH.GT.0)WRITE(KW(2),439)IGRID12KM,ICRPBELD,
	1NOTTOM,SOIL5M,STEXTM,YLATM,XLOXM,DM,
     2LSTNSOILM,SOILNAMEM,MUSYBM,TEXTUREM,LSLOPEM,USLOPEM,HYDROM,FIPSM,
     3YM,XM,ISTATEM,IHUC8M,ICROPNM,ICRPBELDM,SOILVM,ACREWT,ICROPN

      REWIND KR(1)
	IF(MATCH.EQ.0) GO TO 1
      MATCH=0

	REWIND (25)
      READ(25,443)TITLE
	GO TO 15
  439 FORMAT(1X,I8,I2,2X,I5,A6,A7,2F10.3,F10.2,
     13X,I6,2X,A29,A6,A6,1X,2F4.0,2X,A3,2X,I5,2X,
     22F10.3,2X,4I10,2X,A6,F10.0,I10)

  443 FORMAT(A80)
  444 FORMAT(2X,2I8,A6,2X,F8.0,F8.0)
  446 FORMAT(1X,I8,I2,3X,I4,2X,A6,F10.0)
  447 FORMAT(2I8,1X,'NONRI SOIL',4I10)
  998 WRITE(29,447) IHUC8,ICRPBELD,BELDCROSS(ICRPBELD),MATCH,IGRID12KM
      REWIND (25)
      READ(25,443)TITLE
C	WRITE(26,443)TITLE

      GO TO 15
  999 CONTINUE

      END
      include "openv.f"
