C      THIS PROGRAM CREATES SITE FILES FOR 12km Grids
C      USING DATA PROVIDED BY UNC FOR USE WITH EPIC SIMULATIONS
C
      CHARACTER*4 TITLE,AXT
      CHARACTER*9 FDATAH
      CHARACTER*8 COUNTRY,CPROV,BLANK,CONTRY,CPRV
      CHARACTER*16 ASTN, DIR, field
      CHARACTER*20 OPSCFILE,SITEFILE,SOILFILE,WPM1FILE,WINDFILE
      CHARACTER*80 FWTH
      CHARACTER*512  SITEIN
      CHARACTER*1024 RECORD
      CHARACTER*512 SCENDIR, WORKDIR, SHAREDIR, SITDIR 
      COMMON/BK1/FWTH,OPSCFILE,SITEFILE,SOILFILE,ASTN,WPM1FILE,WINDFILE
      COMMON/BK2/TITLE(60),KR(10),KW(10),AXT(1)
      COMMON/BK3/YLAT,XLOG,ELEV,APM,CO2X,CNO3X,RFNX,X1,X2,SNO0
      COMMON/BLK4/WSA,CHL,CHS,CHD,CHN,SN,UPSL,UPS,PEC
      COMMON/BK5/IRR,IRI,IFA,IFD,IDR0,IDF0,MNU,IMW,IGRID
      COMMON/BK6/IGRID12,XLOG12,YLAT12,ELEV12,SLGRID12,MODISLU,
     1IGRID12CT,IHUC,IR,ISF,ICF,CRP,GRAS,AGI,CONTRY,CPRV
      COMMON/BK7/IGRID12A(46000),XLOG12A(46000),YLAT12A(46000),
     1ELEV12A(46000),SLGRID12A(46000),MODISLUA(46000),IHUC8(46000),
     2IREG(46000),IFIPS(46000),CROP(46000),GRASS(46000),AG(46000),
     3COUNTRY(46000),CPROV(46000)
      LOGICAL::XMIS

      DATA KR/10,11,12,13,14,15,16,17,18,19/KW/20,21,22,23,24,25,26,
     127,28,29/AXT/'.SIT'/BLANK/'        '/

      print*, " ---- Begin Site Create ----"
      IGRID12CT=0
      DO 10 IGRID=1,46000
          IGRID12A(IGRID)=0
	  XLOG12A(IGRID)=0
	  YLAT12A(IGRID)=0
	  ELEV12A(IGRID)=0
          SLGRID12A(IGRID)=0
          MODISLUA(IGRID)=0
          IHUC8(IGRID)=0
          IREG(IGRID)=0
          IFIPS(IGRID)=0
          CROP(IGRID)=0
          GRASS(IGRID)=0
	  AG(IGRID)=0
	  COUNTRY(IGRID)=BLANK
	  CPROV(IGRID)=BLANK
   10 CONTINUE

C  modified by unc dyang
C  Read file name from environmental variables
     
      CALL GETENV( "SCEN_DIR", SCENDIR )
      CALL GETENV( "WORK_DIR", WORKDIR )
      CALL GETENV( "SHARE_DIR", SHAREDIR )
      CALL GETENV( "SIT_DIR", SITDIR )

      CALL GETENV( "INFILE1", SITEIN ) 

      CALL OPENV(KR(1), SITEIN, SHAREDIR, 'R')

      CALL OPENV (KW(1), 'GRID12SITE.DAT', WORKDIR, 'W' )
      CALL OPENV (KW(3), 'SITELIST.DAT', SHAREDIR, 'W' )

      READ(KR(1),'(A)') RECORD
      WRITE(KW(1),'(A)') RECORD

C Read variables from common separated file
  200 READ(KR(1),'(A)', END=209) RECORD
C     write(*,*)  RECORD
      call getField( RECORD, ",", 1, field )
      read( field, '(I6)' ) IGRID12
      call getField( RECORD, ",", 2, field )
C     XLOG12 = str2real(field)
      read( field, '(F12.6)' ) XLOG12
      call getField( RECORD, ",", 3, field )
      read( field, '(F12.6)' ) YLAT12
      call getField( RECORD, ",", 4, field )
C     ELEV12 = str2real(field)
      read( field, '(F7.0)' ) ELEV12
      call getField( RECORD, ",", 5, field )
      read( field, '(F12.6)' ) SLGRID12
      call getField( RECORD, ",", 6, field )
      read( field, '(I10)' ) IHUC
      call getField( RECORD, ",", 7, field )
      read( field, '(I6)' ) IR
      call getField( RECORD, ",", 8, field )
      read( field, '(I6)' ) ISF
      call getField( RECORD, ",", 9, field )
      read( field, '(I6)' ) ICF
C     ICF = str2int("field")
C     write(*,*)  "ICF=", ICF,field
      call getField( RECORD, ",", 10, field )
      read( field, '(F12.6)' ) CRP
      call getField( RECORD, ",", 11, field )
      read( field, '(F12.6)' ) GRAS
      call getField( RECORD, ",", 12, field )
      read( field, '(F12.6)' ) AGI
      call getField( RECORD, ",", 13, field )
      read( field, '(A8)' ) CONTRY
      call getField( RECORD, ",", 14, field )
      read( field, '(A8)' ) CPRV
C     print*, "test:", IGRID12, XLOG12, YLAT12, ELEV12, SLGRID12, 
C    1IHUC,IR,ISF,ICF,CRP,GRAS,AGI,CONTRY,CPRV
C end of modification

C 101 FORMAT(3X,I8,10X,F9.4,9X,F9.4,5X,F5.0,10X,F8.4,5X,I4)
  101 FORMAT(2X,I6,2F10.4,F8.0,F8.2,I10,3I6,3F6.2,2A8)

      IGRID12CT=IGRID12CT + 1
      IGRID12A(IGRID12CT)=IGRID12
      XLOG12A(IGRID12CT)=XLOG12
      YLAT12A(IGRID12CT)=YLAT12
      ELEV12A(IGRID12CT)=ELEV12
      SLGRID12A(IGRID12CT)=SLGRID12
      IHUC8(IGRID12CT)=IHUC
      IREG(IGRID12CT)=IR
      IFIPSC=ISF*1000+ICF
      IFIPS(IGRID12CT)=IFIPSC
      CROP(IGRID12CT)=CRP
      GRASS(IGRID12CT)=GRAS
      AG(IGRID12CT)=AGI
      COUNTRY(IGRID12CT)=CONTRY
      CPROV(IGRID12CT)=CPRV

      MODISLUA(IGRID12CT)=MODISLU
      WRITE(KW(1),102) IGRID12CT,IGRID12,XLOG12,YLAT12,ELEV12,SLGRID12,
     1IHUC,IR,IFIPSC,CRP,GRAS,AGI,CONTRY,CPRV
      GO TO 200
C 102 FORMAT(1X,I8,3X,I8,10X,F9.4,9X,F9.4,5X,F5.0,10X,F8.4,5X,I4)
  102 FORMAT(1X,I8,3X,I8,10X,F9.4,9X,F9.4,5X,F5.0,10X,F8.4,5X,I8,
     12X,I2,2X,I5,3F10.2,2A8)

  209 DO 210 IGRID=1,IGRID12CT
C         OPEN (KR(2),FILE='GRIDNAME.DAT', WORKDIR)
          CALL OPENV (KR(2), 'GRIDNAME.DAT', WORKDIR, '')
	  WRITE(KR(2),110)IGRID12A(IGRID)

C RAIN  110 FORMAT(1X,I8,'0')
C IRRIGATED  110 FORMAT(1X,I8,'1')

  110     FORMAT(1X,I8,'0')

          REWIND(KR(2))
	  READ(KR(2),111) FDATAH
          COUNTRY(IGRID) = ADJUSTR(COUNTRY(IGRID))
          CPROV(IGRID) = ADJUSTR(CPROV(IGRID))
	  WRITE(KW(3),109)IGRID12A(IGRID),FDATAH,XLOG12A(IGRID),
     1YLAT12A(IGRID),ELEV12A(IGRID),SLGRID12A(IGRID),
     2IHUC8(IGRID),IREG(IGRID),IFIPS(IGRID),CROP(IGRID),GRASS(IGRID),
     3AG(IGRID),COUNTRY(IGRID),CPROV(IGRID)

C RAIN  109 FORMAT(1X,I8,1X,A9,'.SIT',' RAINFED')
C IRRIGATED  109 FORMAT(1X,I8,1X,A9,'.SIT',' IRRIGATED')
  109   FORMAT(1X,I8,'0',1X,A9,'.SIT',' RAINFED',2F10.4,2X,F7.1,F7.4,2X,
     1I10,2X,I2,2X,I5,3(2X,F7.3),2A8)  
  111   FORMAT(1X,A9)
      
        DIR = FDATAH//AXT(1) 
        CALL OPENV(KW(2),DIR, SITDIR, 'W')
        WRITE(KW(2),112) FDATAH,XLOG12A(IGRID),
     1YLAT12A(IGRID),ELEV12A(IGRID),SLGRID12A(IGRID),
     2IHUC8(IGRID),IREG(IGRID),IFIPS(IGRID),CROP(IGRID),GRASS(IGRID),
     3AG(IGRID),COUNTRY(IGRID),CPROV(IGRID)

C     write(*,*) "IGRID=", IGRID
C     WRITE(*,112) FDATAH,XLOG12A(IGRID),
C    1YLAT12A(IGRID),ELEV12A(IGRID),SLGRID12A(IGRID),
C    2IHUC8(IGRID),IREG(IGRID),IFIPS(IGRID),CROP(IGRID),GRASS(IGRID),
C    3AG(IGRID),COUNTRY(IGRID),CPROV(IGRID)


C-RAIN  112 FORMAT(1X,A9,'.SIT',' RAINFED'//)
C IRRIGATED  112 FORMAT(1X,A9,'.SIT',' IRRIGATED'//)
  112   FORMAT(1X,A9,'.SIT',' RAINFED',' LONGITUDE=',F10.4,
     1' LATITUDE=',F10.4,' ELEVATION= ',F7.1,' M ',' SLOPE %= ',
     2F7.4,/'HUC8=',I9,' PRODUCTION REGION= ',I2,' FIPS CODE= ',I5,
     3' % CROPS= ',F7.3,' % GRASS= ',F7.3,' % AGLAND= ',F7.3/
     4'COUNTRY=',A8,' COUNTRY-PROVINCE=',A8)
C     TITLE=PROBLEM DESCRIPTION(3 LINES)
C     LINES 1/3
C      WRITE(KW(1),299)(TITLE(I),I=1,60)
C  1  YLAT = LATITUDE(DEG)
C  2  XLOG = LONGITUDE(DEG)
C  3  ELEV = ELEVATION OF WATERSHED (M)
C     IN METERS
	ELEV12A(IGRID)=ELEV12A(IGRID)
C  4  APM  = PEAK RATE - EI ADJUSTMENT FACTOR (BLANK IF UNKNOWN)
        APM=1.0
C  5  CO2X = CO2 CONCENTRATION IN ATMOSPHERE (PPM)--NON ZERO VALUE
C            OVERRIDES CO2 INPUT IN EPICCONT.DAT
C         CO2X=372
C         CO2X=413
         CO2X=380

C  6  CNO3X= CONC OF NO3 IN IRRIGATION WATER (PPM)--NON ZERO VALUE
C            OVERRIDES CNO30 INPUT IN EPICCONT.DAT
        CNO3X=0.0 
C  7  RFNX = AVE CONC OF N IN RAINFALL (PPM)
C        RFNX=0.8
         RFNX=0.0
C  8  X1   = DUMMY
        X1=0.0
C  9  X2   = DUMMY
        X2=0.0
C 10  SNO0 = WATER CONTENT OF SNOW ON GROUND AT START OF SIMULATION(MM)
C     LINE 4
        SNO0=0.0
        WRITE(KW(2),303)YLAT12A(IGRID),XLOG12A(IGRID),ELEV12A(IGRID),APM,
     1CO2X,CNO3X,RFNX,X1,X2,SNO0


C  1  WSA  = WATERSHED AREA(HA)
        WSA=10.0
C  2  CHL  = MAINSTEM CHANNEL LENGTH (KM)(BLANK IF UNKNOWN
        CHL=0.0
C  3  CHS  = MAINSTEM CHANNEL SLOPE (M/M)(BLANK IF UNKNOWN
        CHS=0.0
C  4  CHD  = CHANNEL DEPTH (M)
        CHD=0.0
C  5  CHN  = MANNINGS N FOR CHANNEL (BLANK IF UNKNOWN)
        CHN=0.0
C  6  SN   = SURFACE N VALUE (BLANK IF UNKNOWN)
        SN=0.0
C  7  UPSL = UPLAND SLOPE LENGTH (M)
        UPSL=150.
C  8  UPS  = UPLAND SLOPE STEEPNESS (M/M)
C     CONVERT PERCENT SLOPE TO SLOPE RATIO
        UPS=SLGRID12A(IGRID)/100 + 0.0001
C	IF(UPS.EQ.0) UPS=0.001
C  9  PEC  = CONSERVATION PRACTICE FACTOR(=0.0 ELIMINATES WATER EROSION)
        PEC=0.0  
C     LINE 5
        WRITE(KW(2),303)WSA,CHL,CHS,CHD,CHN,SN,UPSL,UPS,PEC
  303 FORMAT(2F8.3,F8.2,4F8.3,F8.4,2F8.3)


C     READ MANAGEMENT INFORMATION
C  1  IRR  = N0 FOR DRYLAND AREAS          | N = 0 APPLIES MINIMUM OF
C          = N1 FROM SPRINKLER IRRIGATION  | VOLUME INPUT, ARMX, & FC-SW
C          = N2 FOR FURROW IRRIGATION      | N = 1 APPLIES INPUT VOLUME
C          = N3 FOR IRR WITH FERT ADDED    | OR ARMX
C          = N4 FOR IRR FROM LAGOON        |
C          = N5 FOR DRIP IRR


C RAIN      IRR=0
C IRRIGATED      IRR=11
	IRR=0


C  2  IRI  = N DAY APPLICATION INTERVAL FOR AUTOMATIC IRRIGATION
        IRI=3

C  3  IFA  = MIN FERT APPL INTERVAL(BLANK FOR USER SPECIFIED)
        IFA=7

C  4  IFD  = 0 WITHOUT FURROW DIKES
C            1 WITH FURROW DIKES
        IFD=0
C  5  IDR0 = 0 NO DRAINAGE
C          = DEPTH OF DRAINAGE SYSTEM(MM)
        IDRO=0
C  6  IDF0 = FERT # FOR AUTO FERT & FERTIGATION--BLANK DEFAULTS TO
C            ELEMENTAL N
        IDFO=52
C  7  MNU  = > 0 AUTO DRY MANURE APPL WITHOUT TRIGGER
        MNU=0
C  8  IMW  = MIN INTERVAL BETWEEN AUTO MOW
        IMW=0
C     LINE 6
        WRITE(KW(2),300)IRR,IRI,IFA,IFD,IDR0,IDF0,MNU,IMW

        CLOSE (KW(2))
	CLOSE (KR(2))

  210 CONTINUE
      print*, "---- Site create run completed. ----"

  299 FORMAT(20A4)
  300 FORMAT(20I4)
  999 STOP
      END
      include "parser.f"
C     include "str2int.f"
C     include "str2real.f"
      include "openv.f"

