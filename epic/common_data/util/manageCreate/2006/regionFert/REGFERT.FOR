C  MODIFIED June 3, 2012 NEW FERTILIZER TIMING 
C  THIS PROGRAM GENERATES INPUT FILE FOR MANAGEMENT FILE FOR EPIC 
      CHARACTER*4 AXT
	CHARACTER*8 REGION
	CHARACTER*9 CROP,BLANK,CROPN,TIMING,TIMINGN,VOID
	CHARACTER*50 ASTN
	CHARACTER*22 FERTSALESNAME,FERTSALESNAMEEPIC
C	INTEGER*8 
      INTEGER BELD4I,BELD4N,BELD4,SPRING,FALL,SPRINGI,FALLI,
     1EPICFERT,FERTSALESID,FERTSALESIDEPIC 
C
	DIMENSION KR(10),KW(50),BELD4I(5,4),BELD4N(5,4),BELD4(5,42),
     1CROP(4),CROPN(42),TIMINGN(5,42),TIMING(5),SPRING(5,4),FALL(5,4),
	2SPRINGI(5,42),FALLI(5,42),FERTFRACN(5,4),FERTFRAC(100,5,42),
	3FERTSALESIDEPIC(100),FERTSALESNAMEEPIC(100),NCRP(6),AXT(43)
      DATA KR/10,11,12,13,14,15,16,17,18,19/KW/20,21,22,23,24,25,26,
     127,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,
     247,48,49,50,51,52,53,44,55,56,57,58,59,60,61,62,63,64,65,66,
     367,68,69/BLANK/'         '/NCRP/4,4,4,4,3,2/AXT/'.C22',
	4'.C23','.C24','.C25','.C26','.C27','.C28','.C29','.C30','.C31',
	5'.C32','.C33','.C34','.C35','.C36','.C37','.C38','.C39','.C40',
	6'.C41','.C42','.C43','.C44','.C45','.C46','.C47','.C48','.C49',
	7'.C50','.C51','.C52','.C53','.C54','.C55','.C56','.C57','.C58',
	8'.C59','.C60','.C61','.C62','.C63','.PRN'/
C     REGION/'REGION 5'/

C      OPEN(KR(1),FILE=
C     &'CornbeltStatesBELD4FertTimingN&PFORPRNrev5-11-12.prn')
      OPEN(KR(2),FILE= 'REGION-DATA-NAME.DAT')
  777	READ(KR(2),112,END=999) ASTN,REGION
  112 FORMAT(A50,A8)
	OPEN(KR(1),FILE=ASTN//AXT(43))

C
      OPEN(KW(50),FILE='12kmFERT-VALIDATE.DAT')
C     INITIALIZE
      DO 200 I=1,5
	DO 201 J=1,4
	BELD4I(I,J)=0
	BELD4N(I,J)=0
	FERTFRACN(I,J) = 0
  201 CONTINUE
      DO 202 J=1,42
      BELD4(I,J) = 0
	DO 212 K=1,100
	FERTFRAC(K,I,J) = 0
  212 CONTINUE
 	CROPN(J) = BLANK
	TIMINGN(I,J) = BLANK
	TIMING(I) = BLANK
  202 CONTINUE
  200 CONTINUE
      NCRPX=1

  299 NC=NCRP(NCRPX)
C     
C     BELD4I(I,J) IS THE INITIAL BELD4 CROP NUMBER BY TIMING (I) 
C     BY CROP (J) IN CROP GROUP
C     CROPS ARE GROUPED BY GROUPS OF 4 OR LESS TO FIT IN EXCEL PRINT FILES 
C     WITHOUT EXCEEDING EXCEL'S BUILT IN RECORD LENGTH
C     CROPN(J) IS THE BELD4 NAME OF THE CROP BY CROP (J) IN CROP GROUP
C     TIMING(I) IS THE ABREVIATED NAME OF THE APPLICATION TIME 
C     BY CROP (I) IN THE CROP GROUP
C     SPRING(I,J) IS A 0/1 CODE WHERE 1 MEANS IT IS SPRING BY TIMING (I) 
C     BY CROP (J) IN CROP GROUP 
C     FALL(I,J) IS A 0/1 CODE WHERE 1 MEANS IT IS FALL BY TIMING (I) 
C     BY CROP (J) IN CROP GROUP 
C     VOID IS A BLANK LINE   
      READ(KR(1),100,END=298) ((BELD4I(I,J),I=1,5),J=1,NC)
	READ(KR(1),102) (CROP(J),J=1,NC)
	READ(KR(1),104) (TIMING(I),I=1,5)
	READ(KR(1),106) ((SPRING(I,J),I=1,5),J=1,NC)
	READ(KR(1),106) ((FALL(I,J),I=1,5),J=1,NC)
	READ(KR(1),108) VOID
C     TIMING PERIOD I=1 IS ACTUALLY A TOTAL AND IS SET TO 2 BELOW 
C     BY CROP IN CROP (J) GROUP
	DO 211 J=1,NC
	SPRING(1,J)= 2
      FALL(1,J) = 2
  211 CONTINUE
C     BELD4N(I,J) IS THE REVISED BELD4 CROP NUMBER BY TIMING (I) 
C     BY CROP (J) IN CROP GROUP WHERE THE CROP NUMBERING STARTS AT 1 INSTED OF 22
	DO 203 I=1,5
	DO 204 J=1,NC
	BELD4N(I,J)= BELD4I(I,J)-21
  204 CONTINUE
  203 CONTINUE
      DO 205 I=1,5
	DO 206 J=1,NC
	BELD4(I,BELD4N(I,J)) = BELD4N(I,J)
      SPRINGI(I,BELD4N(I,J)) = SPRING(I,J)
      FALLI(I,BELD4N(I,J)) = FALL(I,J)
C     BELD4 CROP NUMBERS FOR IRRIGATED CROPS ARE ONE DIGIT GREATER THAN RAINFED CROPS.
C     FERTILIZER ALLOCATION DOES NOT DIFFERENTIATE BETWEEN RAINFED AND IRRIGATED 
C     AT THIS TIME SO THEY ARE TREATED THE SAME AND THE SAME TIMING IS ASSIGNED 
C     TO ARRAYS BELOW

	K = BELD4N(I,J) + 1
	BELD4(I,K) = BELD4N(I,J) + 1
	SPRINGI(I,K) = SPRING(I,J)
      FALLI(I,K) = FALL(I,J)

  206 CONTINUE
  205 CONTINUE
      DO 208 I=1,5
      DO 207 J=1,NC
      CROPN(BELD4N(1,J)) = CROP(J)
C     BELD4 CROP NAMES FOR IRRIGATED CROPS ARE INDEXED ONE DIGIT GREATER THAN RAINFED CROPS.
	K = BELD4N(1,J) + 1
      CROPN(BELD4(1,K)) = CROP(J)
  207 CONTINUE
  208 CONTINUE
C     TIMINGN(I) IS THE ABREVIATED NAME OF THE APPLICATION TIME 
C     BY BELD4 CROP NUMBER
      DO 210 J=1,42
	DO 209 I=1,5
	TIMINGN(I,J) = TIMING(I)
  209 CONTINUE
  210 CONTINUE
     
C     INPUTS ARE WRITTEN TO VERIFY INPUT

      WRITE(KW(50),101) ((BELD4(I,J),I=1,5),J=1,42)
      WRITE(KW(50),103) (CROPN(J),J=1,42)
      WRITE(KW(50),105) ((TIMINGN(I,J),I=1,5),J=1,42)
      WRITE(KW(50),107) ((SPRINGI(I,J),I=1,5),J=1,42)
      WRITE(KW(50),107) ((FALLI(I,J),I=1,5),J=1,42)
C     EPICFERT IS THE EPIC FERTILIZER FILE NUMBER
C     FERTSALESIDEPIC IS THE FERTILIZER SALES CODE NUMBER
C     FERTSALESNAMEEPIC IS THE FERTILIZER SALES NAME
C     FERTFRACN(I,J) IS THE FERTILIZER APPLICATION FRACTION BY TIMING (I)
C     BY CROP (J) BY CROP GROUP

      DO 300 L=1,60
	READ(KR(1),109) EPICFERT,FERTSALESID,FERTSALESNAME,
     1((FERTFRACN(I,J),I=1,5),J=1,NC)
	FERTSALESIDEPIC(EPICFERT) = FERTSALESID
	FERTSALESNAMEEPIC(EPICFERT) = FERTSALESNAME
      DO 220 I=1,5
	DO 221 J=1,NC
	FERTFRAC(EPICFERT,I,BELD4N(I,J)) = FERTFRACN(I,J)
	K= BELD4N(I,J)+1
	FERTFRAC(EPICFERT,I,K) = FERTFRACN(I,J)
  221 CONTINUE
  220 CONTINUE

      WRITE(KW(50),110) EPICFERT,FERTSALESIDEPIC(EPICFERT),
     1FERTSALESNAMEEPIC(EPICFERT),
     2((FERTFRAC(EPICFERT,I,J),I=1,5),J=1,42)
  300 CONTINUE
C     SIX LINES OF SUMMARY INFORMATION FOLLOW EACH GROUP OF CROPS.
C     THESE LINES ARE SKIPPED BY READING VOID
      READ(KR(1),108) VOID
	READ(KR(1),108) VOID
	READ(KR(1),108) VOID
	READ(KR(1),108) VOID
	READ(KR(1),108) VOID
	READ(KR(1),108) VOID
      NCRPX=NCRPX + 1
	IF(NCRPX>6) GO TO 298
C     RETURNS TO READ THE DATA FOR THE NEXT GROUP OF CROPS
      GO TO 299
  298 CONTINUE
C     CREATES REGIONAL FILES BY CROP AND REGION
      DO 400 CRPNUM = 1, 42
      OPEN(KW(CRPNUM),FILE=REGION//AXT(CRPNUM))
	DO 401 I=1,5

	DO 402 K=1,100
C     ONLY WRITES FRACTIONS GREATER THAN ZERO
      IF(FERTFRAC(K,I,CRPNUM)>0.0) GO TO 404
	GO TO 402
C	BEGINS CREATION OF REGIONAL FILES BY CROP AND REGION. 
C     EACH LINE OF THE FILE HAS THE REGION NUMBER FOR EXAMPLE REGION01,
C     THE BELD4 CROP NUMBER, THE BELD4 CROP NAME, THE C FERTILIZER SALES NUMBER, 
C     THE FERTILIZER SALES NAME, THE EPIC FERTILIZER NUMBER, 
C     THE TIME PERIOD ABBREVIATED NAME, THE TIME PERIOD CODE NUMBER, 
C     AND THE FRACTION OF N APPLICATION MET BY THAT FERTILIZER IN THAT TIME PERIOD. NOTE THE TOTAL IS USED LATER WHEN ALL TOTALS ARE ADDED TO DETERMINE THE FRACTION MET WITH MANURE IF THE SUM OF ALL TOTAL IS LESS THAN 1.00.
  404 WRITE(KW(CRPNUM),111) REGION,BELD4(1,CRPNUM),CROPN(CRPNUM),
     2FERTSALESIDEPIC(K),FERTSALESNAMEEPIC(K),K,
     3TIMINGN(I,CRPNUM),I,
     4FERTFRAC(K,I,CRPNUM)

  402 CONTINUE
  401 CONTINUE
  400 CONTINUE
  111 FORMAT(1X,A8,I4,A9,I4,1X,A22,1X,I4,1X,A9,I4,F10.4)

      DO 776 CRPNUM = 1, 42
	CLOSE(KW(CRPNUM))
  776 CONTINUE
      GO TO 777

  100 FORMAT(35X,20(7X,I2))
  101 FORMAT(6(1X,40(I4)))
  102 FORMAT(35X,4(A9,36X))
  103 FORMAT(1X,21(1X,A9,1X,'IR_',A9))
  104 FORMAT(35X,5A9)
  105 FORMAT(1X,210(1X,A9))
  106 FORMAT(35X,20(7X,I2))
  107 FORMAT(1X,210I4)
  108 FORMAT(A9)
  109 FORMAT(I8,I5,A22,20F9.4)
  110 FORMAT(1X,I4,I4,A22,210F9.4)
  999 STOP
      END